From af04c603f5a56598f5011cbb169748d48c0a310c Mon Sep 17 00:00:00 2001
From: padavanonly <padavanonly@github.com>
Date: Sun, 10 Dec 2023 15:14:40 +0800
Subject: [PATCH 08/10] Mediatek:gmac2 use queue 32

---
 .../htdocs/luci-static/resources/view/eqos.js             | 2 +-
 .../applications/luci-app-eqos-mtk/po/templates/eqos.pot  | 2 +-
 .../mtk/applications/luci-app-eqos-mtk/po/zh_Hans/eqos.po | 4 ++--
 .../mtk/applications/luci-app-eqos-mtk/root/usr/sbin/eqos | 8 ++++----
 .../files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.h | 2 +-
 5 files changed, 9 insertions(+), 9 deletions(-)

diff --git a/package/mtk/applications/luci-app-eqos-mtk/htdocs/luci-static/resources/view/eqos.js b/package/mtk/applications/luci-app-eqos-mtk/htdocs/luci-static/resources/view/eqos.js
index 9d303a66e8..1f6546f6be 100644
--- a/package/mtk/applications/luci-app-eqos-mtk/htdocs/luci-static/resources/view/eqos.js
+++ b/package/mtk/applications/luci-app-eqos-mtk/htdocs/luci-static/resources/view/eqos.js
@@ -34,7 +34,7 @@ return view.extend({
 		o.datatype = 'and(uinteger,min(1))';
 		o.rmempty = false;
 
-		s = m.section(form.TableSection, 'device', _('Speed limit based on IP address(using unique comment which is less than 32 and no equal to 8 will enable hardware QOS)'));
+		s = m.section(form.TableSection, 'device', _('Speed limit based on IP address(using unique comment less than 32 will enable hardware QOS'));
 		s.addremove = true;
 		s.anonymous = true;
 		s.sortable = true;
diff --git a/package/mtk/applications/luci-app-eqos-mtk/po/templates/eqos.pot b/package/mtk/applications/luci-app-eqos-mtk/po/templates/eqos.pot
index e68b05b81f..b964024d8b 100644
--- a/package/mtk/applications/luci-app-eqos-mtk/po/templates/eqos.pot
+++ b/package/mtk/applications/luci-app-eqos-mtk/po/templates/eqos.pot
@@ -32,7 +32,7 @@ msgid "Network speed control service."
 msgstr ""
 
 #: applications/luci-app-eqos/htdocs/luci-static/resources/view/eqos.js:38
-msgid "Speed limit based on IP address(using unique comment which is less than 32 and no equal to 8 will enable hardware QOS)"
+msgid "Speed limit based on IP address(using unique comment less than 32 will enable hardware QOS"
 msgstr ""
 
 #: applications/luci-app-eqos/htdocs/luci-static/resources/view/eqos.js:29
diff --git a/package/mtk/applications/luci-app-eqos-mtk/po/zh_Hans/eqos.po b/package/mtk/applications/luci-app-eqos-mtk/po/zh_Hans/eqos.po
index ffdcd8cf8a..bd490d5334 100644
--- a/package/mtk/applications/luci-app-eqos-mtk/po/zh_Hans/eqos.po
+++ b/package/mtk/applications/luci-app-eqos-mtk/po/zh_Hans/eqos.po
@@ -40,8 +40,8 @@ msgid "Network speed control service.(Compatiable with Mediatek HNAT)"
 msgstr "网速控制服务(未设置限速主机可正常使用硬件加速)。"
 
 #: applications/luci-app-eqos/htdocs/luci-static/resources/view/eqos.js:38
-msgid "Speed limit based on IP address(using unique comment which is less than 32 and no equal to 8 will enable hardware QOS)"
-msgstr "基于 IP 限速(设置小于32且不为8的唯一编号将启用硬件QOS.速度设置为0则取消限速)"
+msgid "Speed limit based on IP address(using unique comment less than 32 will enable hardware QOS)"
+msgstr "基于 IP 限速(设置小于32唯一编号将启用硬件QOS.速度设置为0则取消限速)"
 
 #: applications/luci-app-eqos/htdocs/luci-static/resources/view/eqos.js:29
 msgid "Total download bandwidth."
diff --git a/package/mtk/applications/luci-app-eqos-mtk/root/usr/sbin/eqos b/package/mtk/applications/luci-app-eqos-mtk/root/usr/sbin/eqos
index e4a87f1ce1..8c2f75056a 100755
--- a/package/mtk/applications/luci-app-eqos-mtk/root/usr/sbin/eqos
+++ b/package/mtk/applications/luci-app-eqos-mtk/root/usr/sbin/eqos
@@ -37,11 +37,11 @@ case "$1" in
 		ip6tables -t mangle -D FORWARD -i br-lan -j DSCP --set-dscp 0
 		ip6tables -t mangle -D FORWARD -o br-lan -j DSCP --set-dscp 0
 		echo "10 0" > /sys/kernel/debug/hnat/hnat_setting
-		for i in $(seq 0 7); do
-		echo 0 0 0 0 0 0 0 > $hqos_path/qdma_txq$i
+		for i in $(seq 0 31); do
+		echo 0 0 0 0 0 4 4 > $hqos_path/qdma_txq$i
 		done
-		for i in $(seq 8 15); do
-		echo 1 0 0 0 0 0 0 > $hqos_path/qdma_txq$i
+		for i in $(seq 32 63); do
+		echo 1 0 0 0 0 4 4 > $hqos_path/qdma_txq$i
 		done	
 	;;
 	"start")
diff --git a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.h b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.h
index 13b63de8ba..1b55ed447e 100644
--- a/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.h
+++ b/target/linux/mediatek/files-5.4/drivers/net/ethernet/mediatek/mtk_eth_soc.h
@@ -479,7 +479,7 @@
 #define QID_HIGH_BITS(x)        ((((x) >> 4) & 0x3) << 20)
 #define QID_BITS_V2(x)		(((x) & 0x3f) << 16)
 
-#define MTK_QDMA_GMAC2_QID	8
+#define MTK_QDMA_GMAC2_QID	32
 
 /* QDMA V2 descriptor txd6 */
 #define TX_DMA_INS_VLAN_V2         BIT(16)
-- 
2.43.0

